# This file can update the JupyterHub Helm chart's default configuration values.
#
# For reference see the configuration reference and default values, but make
# sure to refer to the Helm chart version of interest to you!
#
# Introduction to YAML:     https://www.youtube.com/watch?v=cdLNKUoMc6c
# Chart config reference:   https://zero-to-jupyterhub.readthedocs.io/en/stable/resources/reference.html
# Chart default values:     https://github.com/jupyterhub/zero-to-jupyterhub-k8s/blob/HEAD/jupyterhub/values.yaml
# Available chart versions: https://hub.jupyter.org/helm-chart/
#

proxy:
  https:
    enabled: true
    hosts:
      - 0.0.0.0
    type: secret
    secret:
      name: tls-secret
  service:
    type: NodePort
    nodePorts:
      https: 32443

hub:    
  extraVolumes:
    - name: custom-templates
      configMap:
        name: jupyterhub-templates
  extraVolumeMounts:
      - name: custom-templates
        mountPath: /usr/local/share/jupyterhub/custom_templates
  extraEnv:
    OAUTH_CLIENT_ID:
      valueFrom:
        secretKeyRef:
          name: google-oauth-secret
          key: client-id
    OAUTH_CLIENT_SECRET:
      valueFrom:
        secretKeyRef:
          name: google-oauth-secret
          key: client-secret
    OAUTH_CALLBACK_URL:
      valueFrom:
        secretKeyRef:
          name: google-oauth-secret
          key: oauth-callback-url
    ALLOWED_USERS_JSON:
      valueFrom:
        secretKeyRef:
          name: allowed-users
          key: users
    ADMIN_USER:
      valueFrom:
        secretKeyRef:
          name: allowed-users
          key: admin
  extraConfig:
      01-google-oauth.py: |
        import os
        c.GoogleOAuthenticator.client_id = os.environ["OAUTH_CLIENT_ID"]
        c.GoogleOAuthenticator.client_secret = os.environ["OAUTH_CLIENT_SECRET"]
        c.GoogleOAuthenticator.oauth_callback_url = os.environ["OAUTH_CALLBACK_URL"]
        c.Authenticator.allow_all = True
      03-allowed-users.py: |
        import json
        import os

        raw_users = os.environ.get("ALLOWED_USERS_JSON", "[]")
        allowed_users = set(json.loads(raw_users))
        admin_user = os.environ.get("ADMIN_USER", "").strip()
        if admin_user:
          c.Authenticator.admin_users = {admin_user}
        if allowed_users:
          c.Authenticator.allow_all = False
          c.Authenticator.allowed_users = allowed_users
      02-user-env.py: |
        c.KubeSpawner.environment = {
            "JUPYTERHUB_USER": "{username}",
            "JUPYTERHUB_USER_ESCAPED": "{escaped_username}"
        }
  config:
    Authenticator: {}
    GoogleOAuthenticator:
      hosted_domain:
        - uw.edu.pl
        - student.uw.edu.pl
      login_service: uw.edu.pl or student.uw.edu.pl
      username_claim: email
    #######################################
    JupyterHub:
        authenticator_class: google
        template_paths: 
          - "/usr/local/share/jupyterhub/custom_templates/"
        template_vars:
            announcement: "Please shut down servers when finished."

    KubeSpawner:
      # Pod resource limits and guarantees
      cpu_limit: 2
      cpu_guarantee: 0.5
      mem_limit: 8G
      mem_guarantee: 1G
      
      # Increase spawn timeout for slow initialization (LCG setup, etc.)
      http_timeout: 120
      start_timeout: 120
      
      ################################################
      # User-selectable image profiles
      profile_list:   
        - display_name: "HEP"
          description: "Centos9 with CVMFS support for HEP software"
          kubespawner_override:
            image: gitlab-registry.cern.ch/akalinow/cmssw-docker/el9-cms:latest
            #image_pull_policy: Always
            default: true
            cpu_limit: 8
            cpu_guarantee: 0.5
            mem_limit: 32G
            mem_guarantee: 8G
            env:
              LCG_VERSION:
                valueFrom:
                  configMapKeyRef:
                    name: configs
                    key: LCG_VERSION
              LCG_ARCH:
                valueFrom:
                  configMapKeyRef:
                    name: configs
                    key: LCG_ARCH
            cmd:
            - /bin/bash
            - -lc
            - |
              #Create Jupyter kernel for PyROOT with LCG environment
              KERNEL_DIR=$HOME/.local/share/jupyter/kernels
              mkdir -p $KERNEL_DIR
              #Copy kernels
              cp -rL /cvmfs/sft.cern.ch/lcg/views/${LCG_VERSION}/${LCG_ARCH}/share/jupyter/kernels/* $KERNEL_DIR/
              cp -rL /cvmfs/sft.cern.ch/lcg/views/${LCG_VERSION}/${LCG_ARCH}/etc/notebook/kernels/* $KERNEL_DIR/

              # Link tutorials to user home
              ln -s /cvmfs/sft.cern.ch/lcg/views/${LCG_VERSION}/${LCG_ARCH}/share/jupyter/tutorials $HOME/tutorials

              #Remove R kernel which does not work in this setup
              rm -rf $KERNEL_DIR/ir

              #Fix the PyROOT kernel to source the LCG environment before starting the kernel
              rm -rf $KERNEL_DIR/root_cpp
              mv $KERNEL_DIR/root $KERNEL_DIR/root_cpp

              cat > $KERNEL_DIR/python3/kernel.json << EOF
              {
                "argv": [
                  "/bin/bash",
                  "-l",
                  "-c",
                  "source /cvmfs/sft.cern.ch/lcg/views/${LCG_VERSION}/${LCG_ARCH}/setup.sh && exec python -m ipykernel_launcher -f {connection_file}"
                ],
                "display_name": "Python (${LCG_VERSION})",
                "language": "python",
                "env": {
                  "PYTHONNOUSERSITE": "1",
                  "LC_ALL": "C",
                  "LANG": "C"
                },
                "metadata": {
                  "debugger": true
                }
              }
              EOF

              #Fix ROOT C++ kernel to source the LCG environment before starting the kernel
              cat > $KERNEL_DIR/root_cpp/kernel.json << EOF
              {
                "argv": [
                  "/bin/bash",
                  "-l",
                  "-c",
                  "source /cvmfs/sft.cern.ch/lcg/views/${LCG_VERSION}/${LCG_ARCH}/setup.sh && exec python3 -m JupyROOT.kernel.rootkernel -f {connection_file}"
                ],
                "display_name": "C++ (${LCG_VERSION})",
                "language": "cpp"
              } 
              EOF

              mkdir -p  /home/jovyan/.jupyter/lab/user-settings/@jupyterlab/filebrowser-extension/
              cat << EOF > /home/jovyan/.jupyter/lab/user-settings/@jupyterlab/notebook-extension/tracker.jupyterlab-settings
              {
                  "codeCellConfig": {
                      "lineNumbers": true
                  }
              }
              EOF

              cat << EOF > $HOME/.bash_profile
              export PS1='[\t] \e[91mhepuser\e[0m '
              # environment setup functions
              lcg() { source /cvmfs/sft.cern.ch/lcg/views/${LCG_VERSION}/${LCG_ARCH}/setup.sh; }
              ilc() { source /cvmfs/ilc.desy.de/initILCSOFT.sh v01-10; }
              dune() { echo "DUNE software environment is not available in this image."; }
              sk() { echo "SK software environment is not available in this image."; }

              echo -e "\e[31m      ▗▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▖"
              echo -e "     ▟██████████████████████████████████████▙"
              echo -e "    ▟█▀▀                                ▀▀█▙"
              echo -e "   ▟█    \e[30m███████╗ ██████╗██╗ ██████╗ ███████╗\e[31m   █▙"
              echo -e "  ▟█     \e[30m╚══███╔╝██╔════╝██║██╔═══██╗██╔════╝\e[31m    █▙"
              echo -e " ▟█        \e[30m███╔╝ ██║     ██║██║   ██║█████╗\e[31m       █▙"
              echo -e " ▜█       \e[30m███╔╝  ██║     ██║██║   ██║██╔══╝\e[31m       ▛█"
              echo -e "  ▜█     \e[30m███████╗╚██████╗██║╚██████╔╝██║\e[31m         ▛█"
              echo -e "   ▜█    \e[30m╚══════╝ ╚═════╝╚═╝ ╚═════╝ ╚═╝\e[31m        ▛█"
              echo -e "    ▜█▄▄                                ▄▄█▛"
              echo -e "     ▜██████████████████████████████████████▛"
              echo -e "      ▝▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▘\e[0m"
              echo ""
              
              if [[ -f /etc/os-release ]] && grep -Eq '^(ID|ID_LIKE)=.*(rhel|centos|almalinux|rocky)' /etc/os-release; \
                 then
                echo -e "\e[94mAvailable environment setup functions:\e[0m lcg, ilc"
              fi
              
              EOF

              cat << EOF > $HOME/.jupyter/jupyter_server_config.py
              c.ServerApp.terminado_settings = {
                "shell_command": ["/bin/bash","-l","-i"]
              }
              EOF

              
              #Start JupyterHub singleuser process
              exec jupyterhub-singleuser
          
            lifecycle_hooks:
              postStart:
                exec:
                  command:
                    - /bin/bash
                    - -c
                    - |    
                      mkdir -p $HOME/.jupyter




        - display_name: "AI/ML"
          description: "Ubuntu with TensorFlow, PyTorch and GPU support"
          kubespawner_override:
            #image: quay.io/jupyter/tensorflow-notebook:cuda-latest
            image: akalinow/tensorflow-gpu:TF2.20
            #image_pull_policy: Always
            cpu_limit: 8
            cpu_guarantee: 0.5
            mem_limit: 32G
            mem_guarantee: 8G
            nvidia.com/gpu: "1"
            lifecycle_hooks:
              postStart:
                  exec:
                    command:
                      - /bin/bash
                      - -c
                      - |    
                        # Remove kennels installed by LCG
                        KERNEL_DIR=$HOME/.local/share/jupyter/kernels
                        rm -rf $KERNEL_DIR/*
#######################################################
#######################################################
singleuser: 
  startTimeout: 600
  cmd: 
    - jupyterhub-singleuser
  cpu:
    limit: 2
    guarantee: 0.5
  memory:
    limit: 8G
    guarantee: 1G
  storage:
    type: none
    extraVolumes:
      01-cvmfs:
        name: cvmfs
        persistentVolumeClaim:
          claimName: cvmfs-pvc
      02-cmsse:
        name: cmsse-nfs
        persistentVolumeClaim:
          claimName: cmsse-nfs-pvc
      03-scratch:
        name: scratch-local
        persistentVolumeClaim:
          claimName: scratch-local-pvc
    extraVolumeMounts:
      01-cvmfs:
        name: cvmfs
        mountPath: /cvmfs
        readOnly: true
        mountPropagation: HostToContainer
      02-cmsse:
        name: cmsse-nfs
        mountPath: /scratch_cmsse
        readOnly: true
      03-scratch:
        name: scratch-local
        mountPath: /home/jovyan
        subPathExpr: $(JUPYTERHUB_USER)
#######################################################
#######################################################

